# NYC Commute App - Agent Handoff ðŸš€

## Project Overview
This is a **Next.js** application designed to provide a "Premium" commute tracking experience for NYC transit.
It aggregates data from **MTA Subway/Bus**, **NJ Transit**, **PATH**, **LIRR**, **Metro-North**, and **NYC Ferry**.

## Key Architecture & Decisions
We prioritize **Reliability** and **Aesthetics**.
Most modules use a **Hybrid Approach**: Real-time Data + Static Schedule Fallback.

### 1. NJ Transit (Rail)
*   **Source**: **GTFS-Realtime (Protobuf)** feed from `testraildata.njtransit.com`.
    *   *Why?* The JSON API has a strict 10-req/day limit. The GTFS feed uses a reusable token.
*   **Logic**: `src/lib/njt_gtfs.ts` handles fetching/decoding. `src/lib/njt.ts` orchestrates the logic.
*   **Fallback**: If GTFS is empty, we fall back to `src/lib/njt_schedule_fallback.json` (Static Schedule for common lines like NEC/RVL).
*   **Mapping**: `src/lib/njt_gtfs_mapping.json` maps App Station Codes (e.g. `SM`) to GTFS Numeric IDs.

### 2. MTA Bus
*   **Source**: **GTFS-Realtime** (`gtfsrt.prod.obanyc.com`).
    *   *Why?* The user's API Key didn't work for the OBA Discovery API.
*   **Search**: We **cannot** use the API to search routes. Instead, we use a local **Static Index** (`src/lib/mta_bus_index.json`) generated by scraping the active feed.
*   **Logic**: `src/lib/mta_bus_gtfs.ts` fetches live updates. `src/lib/mta.ts` handles search via the static index.

### 3. NYC Ferry
*   **Source**: Sparse GTFS-RT feed.
*   **Problem**: The feed omits Route IDs and Destinations often.
*   **Solution**: **Route Inference**. We match observed stop IDs against static line definitions (`src/lib/ferry_routes.ts`) to guess if a boat is "East River" or "Astoria".
*   **Hybrid**: We pre-fill `src/lib/ferry_schedule.ts` trips and merge live boats on top ("Live" vs "Scheduled").

### 4. PATH Train
*   **Source**: Public GTFS-RT (`https://path.transitdata.nyc/gtfsrt`).
*   **Logic**: Integrated into `src/lib/path.ts` called by the main MTA router.

## Environment Variables (.env.local)
The user has valid keys for all services.
required:
*   `NJT_USERNAME` / `NJT_PASSWORD`: For NJT Token generation.
*   `MTA_API_KEY`: For Subway/Rail Feeds (New Portal).
*   `NEXT_PUBLIC_MTA_BUS_API_KEY`: For Bus GTFS-RT (Note: Invalid for OBA Search).

## Critical Files
*   `src/lib/mta.ts`: Main MTA/Bus/PATH service hub.
*   `src/app/api/mta/route.ts`: Main API endpoint processing feeds (handling Protobuf/Types).
*   `src/lib/njt.ts`: NJT orchestrator.
*   `scripts/`: Contains vital verification/debug scripts (`verify_bus_final.js`, `verify_njt_gtfs.ts`, `assess_ferry.ts`).

## Status
*   **Bus**: Recently verified working (Search M23 -> Realtime).
*   **NJT**: Resilient (Hybrid).
*   **Ferry**: Hybrid & Inferred.

## Next Steps / TODOs
*   **Bus Stops**: Currently `getBusStops` returns a mock "Any Stop" because we lack a Stop DB. Ideally, we should scrape stops or implement a proper stop selector.
*   **Code Cleanup**: `mta.ts` is getting large.
